name: Refresh Demo
on:
  workflow_dispatch: {}                 # 手动触发
  schedule:
    - cron: "0 * * * *"                 # 每小时(UTC);北京时间 +8
  push:
    paths:
      - ".github/workflows/main.yml"    # 此文件变动时触发
permissions:
  contents: write
jobs:
  refresh-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 'latest'  # 使用最新版本
      - name: Build project with shadcn
        shell: bash
        run: |
          rm -rf temp-app
          npx --yes create-next-app@latest temp-app \
            --yes --ts --eslint --tailwind --app --src-dir --turbopack --import-alias "@/*"
          npx --yes shadcn@canary init \
            --cwd temp-app -t next -b slate --src-dir --css-variables -y
          npx --yes shadcn@canary add \
            --cwd temp-app --all -y -o
          shopt -s dotglob nullglob
          for item in * .*; do
            case "$item" in
              .|..|.git|temp-app) continue ;;
              *) rm -rf "$item" ;;
            esac
          done
          cp -a temp-app/. .
          rm -rf temp-app
      - name: Install & Build
        shell: bash
        run: |
          npm install
          npm run build || true
      - name: Commit & Force Push (Demo only)
        shell: bash
        run: |
          set -e
          git config user.name  "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          TIME=$(TZ=Asia/Shanghai date +"%Y-%m-%d %H:%M:%S")
          
          # 切换到 Demo 分支
          git checkout Demo 2>/dev/null || git checkout --orphan Demo
          
          # 添加所有变更
          git add -A
          
          # 检测变更类型并生成 commit message
          if git diff --cached --quiet; then
            # 没有变更
            echo "No changes to commit"
            exit 0
          fi
          
          # 统计变更
          ADDED=$(git diff --cached --name-status | grep "^A" | wc -l)
          MODIFIED=$(git diff --cached --name-status | grep "^M" | wc -l)
          DELETED=$(git diff --cached --name-status | grep "^D" | wc -l)
          
          # 根据主要变更类型生成 commit message
          if [ "$ADDED" -gt 0 ] && [ "$MODIFIED" -eq 0 ] && [ "$DELETED" -eq 0 ]; then
            MESSAGE="Add $TIME"
          elif [ "$MODIFIED" -gt 0 ] && [ "$ADDED" -eq 0 ] && [ "$DELETED" -eq 0 ]; then
            MESSAGE="Up $TIME"
          elif [ "$DELETED" -gt 0 ] && [ "$ADDED" -eq 0 ] && [ "$MODIFIED" -eq 0 ]; then
            MESSAGE="$TIME"  # 删除的不写备注，只有时间戳
          else
            # 混合变更，选择数量最多的类型
            if [ "$ADDED" -ge "$MODIFIED" ] && [ "$ADDED" -ge "$DELETED" ]; then
              MESSAGE="Add $TIME"
            elif [ "$MODIFIED" -ge "$ADDED" ] && [ "$MODIFIED" -ge "$DELETED" ]; then
              MESSAGE="Up $TIME"
            else
              MESSAGE="$TIME"
            fi
          fi
          
          # 提交并强制推送
          git commit -m "$MESSAGE"
          git push --force origin Demo
